# 多语言（i18n）开发与使用指南

本文档说明 CodexFlow 的多语言架构、目录与命名规则、开发流程、校验脚本以及“非开发者”如何扩展语言。

## 架构与职责

- 技术栈：i18next + react-i18next + i18next-icu
- 目录：
  - 渲染端初始化：`web/src/i18n/setup.ts`
  - 资源文件：`web/src/locales/<lng>/<namespace>.json`
  - 主进程语言管理与 IPC：`electron/i18n.ts`
  - 预加载桥接：`electron/preload.ts`（暴露 `window.host.i18n`）
  - 校验脚本：`scripts/i18n-check.js`

## 命名空间与键规则

- 命名空间按模块拆分：`common`、`settings`、`projects`、`terminal`、`history`、`at`
- 键使用“语义化路径”：`settings.language.label`、`history.cleanup.desc`
- 组件内引用：
  - `const { t } = useTranslation('settings')`
  - `t('settings:language.label')`
- ICU/参数插值：`t('settings:historyCleanup.result', { ok, notFound, failed })`

## 渲染端初始化（`web/src/i18n/setup.ts`）

- 通过 `import.meta.glob('../locales/**/*.json')` 预注册资源，按需加载命名空间。
- 语言来源：优先主进程 `window.host.i18n.getLocale()`，否则 `navigator.language`。
- 用户目录语言包优先于打包内资源（见“用户自定义语言包”）。
- 关键配置：`fallbackLng: 'en'`，`returnNull/returnEmptyString: false`（避免空翻译导致 UI 空白）。
- 导出：
  - `initI18n()`：应用启动时调用（已在 `web/src/main.tsx` 集成）。
  - `changeAppLanguage(locale)`：手动切换语言（通常通过设置页）。
  - `listAvailableLanguages()`：聚合“打包内 + 用户目录”的语言列表。

## 主进程语言管理（`electron/i18n.ts`）

- 状态：`getCurrentLocale()`、`setCurrentLocale()`，变更时广播 `i18n:localeChanged`。
- IPC：
  - `i18n.getLocale` / `i18n.setLocale`
  - 用户语言包：
    - `i18n.userLocales.dir` → 返回用户目录路径
    - `i18n.userLocales.list` → 列出 `userData/locales/*` 语言
    - `i18n.userLocales.read` → 读取 `userData/locales/<lng>/<ns>.json`

## 预加载桥接（`electron/preload.ts`）

```ts
window.host.i18n.getLocale(): { ok, locale? }
window.host.i18n.setLocale(locale): { ok, locale? }
window.host.i18n.onLocaleChanged(cb)
window.host.i18n.userLocales.dir() / list() / read(lng, ns)
```

## 开发者工作流

1) 新增/修改文案：在组件内使用 `t('ns:key')`，不要硬编码字符串。
2) 资源文件：在 `web/src/locales/en|zh/<ns>.json` 增加对应键，英文作为基线。
3) 运行校验脚本：
   - 报告：`npm run i18n:report`
   - 严格：`npm run i18n:check`（CI/预提交自动执行）
4) 运行应用，打开设置页切换语言进行验证。

> 说明：校验脚本会扁平化 JSON 进行键集合比对，基线语言默认 `en`，可通过 `BASE_LNG=xx` 配置。

## 非开发者：用户自定义语言包

无需修改代码或重新打包即可新增语言：

- 位置：`%APPDATA%/codexflow/locales/<lng>/<namespace>.json`
- 示例：`C:\\Users\\you\\AppData\\Roaming\\codexflow\\locales\\ja\\common.json`
- 规则：
  - 命名空间与键需与英文基线一致。
  - 用户目录资源优先级更高，可用于覆盖打包内内容。
  - 设置页语言列表会自动出现该语言（无须手动注册）。

最小示例 `common.json`：

```json
{
  "app": { "name": "CodexFlow" },
  "common": { "ok": "OK", "cancel": "Cancel", "save": "Save", "open": "Open" }
}
```

## 模板与示例

- 英文基线模板：`docs/locales-template/en/*.json`
- 用法：
  - 非开发者：将 `docs/locales-template/en/` 拷贝至 `%APPDATA%/codexflow/locales/<lng>/` 并翻译值。
  - 开发者：将其拷贝至 `web/src/locales/<lng>/` 并翻译，之后运行 `npm run i18n:report` 校验差异。

## 诊断与故障排查

- 详细日志默认关闭：
  - 主进程：`CODEX_DIAG_LOG=1` 环境变量开启
  - 渲染端：`localStorage.setItem('CF_DIAG_LOG','1')` 开启
- 常见问题：
  - UI 文案未显示：检查键是否存在、命名空间是否匹配（`i18n:report`）。
  - 用户语言不生效：确认目录与文件名（`locales/<lng>/<ns>.json`），重启应用或重新打开设置页。
